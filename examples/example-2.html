<!DOCTYPE html>
<!-- noSheetLibrary --->
<html lang="en" dir="ltr" data-theme="light">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <meta name="color-scheme" content="dark light">

    <title>Example 2 - Multiple Facets &amp; References | NoSheet</title>
    <!-- Stylesheets --->
    <link href="css/prism.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.classless.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.colors.min.css">
    <style>
        :root {
            --pico-font-size: 100%;
        }

        input[type="number"] {
            margin-bottom: 0;
        }

        .parent {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: 1fr;
            grid-column-gap: var(--pico-spacing);
            grid-row-gap: 0px;
        }

        .div1 {
            grid-area: 1 / 1 / 2 / 2;
        }

        .div2 {
            grid-area: 1 / 2 / 2 / 3;
        }
    </style>
    <!-- JS Content -->
    <script src="js/examples/utils.js"></script>
    <script src="js/examples/simple_alpine_table.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@formulajs/formulajs/lib/browser/formula.min.js" crossorigin="anonymous"></script>
    <script src="js/prism.js" data-manual></script>
</head>

<body>
    <header>
        <hgroup>
            <h1>Example 2 - Multiple Facets &amp; References</h1>
        </hgroup>
        <hgroup>
            <h3>Extending the Simple Quote Calculator with additional facets</h3>
        </hgroup>
    </header>
    <main>
        <div>
            <p>Change the manufacturing cost for all line items by adjusting the <code>manufacturing_cost_per_m2</code>
                parameter in the <a href="#raw_materials">raw_materials</a> facet</p>
            <p>Set a minimum Margin Threshold for the quote through the <code>low_margin_threshold</code> parameter in
                the <a href="#gross_margin">gross_margin</a> facet</p>
        </div>
        <div>
            <form>
                <fieldset>
                    <div class="parent">
                        <div class="div1">
                            <label for="Manufacturing_Cost">Manufacturing Cost:
                                <input id="Manufacturing_Cost" x-data="referenceHandler('manufacturing_cost_per_m2')"
                                    x-model="value" type="number" min="0" max="100" step="0.1" x-bind="input">
                                <label for="Manufacturing_Cost">per m<sup>2</sup></label>
                            </label>
                        </div>
                        <div class="div2">
                            <label for="Margin_Threshold">Margin Threshold:
                                <input id="Margin_Threshold" x-data="referenceHandler('low_margin_threshold')"
                                    x-model="value" type="number" min="0" max="100" x-bind="input">
                            </label>
                        </div>
                    </div>
                </fieldset>
            </form>
        </div>

        <div x-data="simpleNoSheetTable('lineitemsTable')">
            <table class="table-fixed" width="100%" :class="storeId" x-data="{columns:[]}">
                <thead>
                    <tr class="text-center">
                        <th x-init="columns.push('item')">Item</th>
                        <th x-init="columns.push('steel_m2')">Steel m<sup>2</sup></th>
                        <th x-init="columns.push('unit_cost')">Item Cost</th>
                        <th x-init="columns.push('unit_offer')">Unit Price</th>
                        <th x-init="columns.push('quantity')">Quantity</th>
                        <th x-init="columns.push('line_cost')">Line Cost</th>
                        <th x-init="columns.push('line_offer')">Line Offer</th>
                        <th x-init="columns.push('gross_margin')">Gross Margin</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="(item, row_index) in items" :key="row_index">
                        <tr :id="`${storeId}-row[${row_index}]`">
                            <template x-for="(column_name, html_column_index) in columns">
                                <td x-data="{column_index: storedTable.columnIndex(column_name)}"
                                    :class="`col_${column_name}`"
                                    :id="`${storeId}_cell[${row_index}][${column_index}]`">
                                    <template x-if="[1,2,3].includes(column_index)">
                                        <input type="number" min="0" :value="item[column_index]"
                                            @input="setCellValue(row_index, column_index, +$el.value)">
                                    </template>

                                    <template x-if="!column_index">
                                        <!--Don't update on calculation-->
                                        <span x-text="item[column_index]"></span>
                                    </template>

                                    <template x-if="[4,5,6].includes(column_index)">
                                        <!--Update on calculation-->
                                        <!-- calculation may occur during load/unload in which case items[row_index] may be 'undefined' -->
                                        <div x-text="item[column_index].toFixed(2)"
                                            x-init="$watch('calculationTick', _ => $el.innerHTML = items[row_index]?.[column_index].toFixed(2))">
                                        </div>
                                    </template>

                                    <template x-if="column_index == 7">
                                        <!--Update on calculation-->
                                        <!-- calculation may occur during load/unload in which case items[row_index] may be 'undefined' -->
                                        <div x-text="percent_format.format(item[column_index])"
                                            x-init="$watch('calculationTick', _ => $el.innerHTML = percent_format.format(items[row_index]?.[column_index]))">
                                        </div>
                                    </template>

                                </td>
                            </template>
                        </tr>
                    </template>
                    <tr x-show="isEmpty">
                        <td colspan="5">No matching records found.</td>
                    </tr>
                </tbody>
                <tfoot>
                    <tr>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th>
                            <div x-data="aggregate('total_cost')" x-text="Number(value).toFixed(2)" class="text-right">
                            </div>
                        </th>
                        <th>
                            <div x-data="aggregate('total_offer')" x-text="Number(value).toFixed(2)" class="text-right">
                            </div>
                        </th>
                        <th></th>
                    </tr>
                    <tr>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th>Profit:</th>
                        <th>
                            <div x-data="aggregate('profit')" x-text="Number(value).toFixed(2)">
                            </div>
                        </th>
                        <th>
                            <span x-data="aggregate('low_margin_warning')"
                                :class="value ? 'pico-color-red-500' : 'pico-color-green-500'">
                                <div x-data="aggregate('gross_margin', percent_format)" x-text="value"></div>
                            </span>
                        </th>
                    </tr>

                </tfoot>
            </table>

            <div>
                <button @click="storedTable.load(getRandomData(), 'random_data');reset();">Load
                    Random Data
                </button>
                <button @click="storedTable.unload('random_data');reset();">
                    Unload All Random Data
                </button>
            </div>
        </div> <!-- simpleTable()-->

        <div>
            <hr>
            <h3>Create and populate the noSheet table:</h3>
            <pre>
                <code id="prism-1" class="language-javascript"></code>
            </pre>
            <h3 id="raw_materials">The raw materials facet:</h3>
            <pre>
                <code src="/js/examples/facets/raw_materials.mjs" class="prism-fetch language-javascript"></code>
            </pre>
            <h3 id="lineitems">The line items facet:</h3>
            <pre>
                <code src="/js/examples/facets/lineitems.mjs" class="prism-fetch language-javascript"></code>
            </pre>
            <h3 id="gross_margin">The gross margin facet:</h3>
            <pre>
                <code src="/js/examples/facets/gross_margin.mjs" class="prism-fetch language-javascript"></code>
            </pre>
        </div>
    </main>
    <script>
        const SUM = formulajs.SUM;
        var percent_format = new Intl.NumberFormat(undefined, { style: "percent" });

        //
        // Load the noSheet library, facets and create and populate a table
        //    
        var whenNoSheetReady = new Promise((resolve) => {

            (async () => {

                //the library
                const { defineStack, createTable } = await import('/js/nosheet.min.mjs');

                //the facets
                const { default: raw_materials } = await import('/js/examples/facets/raw_materials.mjs');
                const { default: lineitems } = await import('/js/examples/facets/lineitems.mjs');
                const { default: gross_margin } = await import('/js/examples/facets/gross_margin.mjs');

                //the data
                const response = await fetch('/js/examples/data/example_1.json');
                const data = response.ok ? await response.json() : [];

                //-prism
                //
                //create and define the table
                //        
                let new_table = createTable(['item', 'steel_m2', 'unit_offer', 'quantity'], raw_materials, lineitems, gross_margin);

                //The raw_materials facet requires two external references; manufacturing_cost_per_m2 and average_steel_cost_m2.
                //Here we set average_steel_cost_m2 to be a constant
                //manufacturing_cost_per_m2 is set dynamically using Alpine
                new_table.setReferences(function () {

                    this.average_steel_cost_m2 = 0.2;
                });

                //
                //populate the table
                //
                new_table.load(data);
                //-prism

                resolve(new_table);
            })()
        });

        function referenceHandler(referenceName) {
            return {

                init() {

                    //watch the store for reference initialization
                    this.$watch(`$store.${referenceName}`, (newHandler, oldHandler) => {
                        this.value = newHandler.value;
                    })
                },
                value: '',
                input: {
                    ['@input'](event) {
                        Alpine.store(referenceName).value = +event.srcElement.value;
                    },
                },
            };
        };

        //
        //Plumb in Alpine
        //
        document.addEventListener('alpine:init', () => {

            console.log('alpine:init');
            Alpine.store('lineitemsTable', {});

            whenNoSheetReady.then((theTable) => {

                console.log('whenNoSheetReady');

                Alpine.store('low_margin_threshold', theTable.getReferenceHandle('low_margin_threshold', 30));
                Alpine.store('manufacturing_cost_per_m2', theTable.getReferenceHandle('manufacturing_cost_per_m2', 0.3));

                theTable.calculate();

                //update the store with the loaded nosheet table
                Alpine.store('lineitemsTable', theTable);
            });
        });       
    </script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" crossorigin="anonymous"></script>
</body>

</html>