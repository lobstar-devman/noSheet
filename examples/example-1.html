<!DOCTYPE html>
<!-- noSheetLibrary --->
<html lang="en" dir="ltr" data-theme="light">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <meta name="color-scheme" content="dark light">

    <title>Example 1 - A Simple Quote Calculator | NoSheet</title>
    <!-- Stylesheets --->
	<link href="css/prism.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.classless.min.css">
    <style>
    :root {
        --pico-font-size: 100%;
    }
    input[type="number"] {
        margin-bottom: 0;
    }
    </style>    
    <!-- JS Content -->
    <script src="js/examples/utils.js"></script>
    <script src="js/examples/simple_alpine_table.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@formulajs/formulajs/lib/browser/formula.min.js" crossorigin="anonymous"></script>
    <script src="js/prism.js" data-manual></script>
</head>

<body>
    <header>
        <hgroup>
            <h1>
                Example 1 - A Simple Quote Calculator
            </h1>
        </hgroup>            
    </header>
    <main>
        <div>
            <p>This table is calculated using the <a href="#lineitems">lineitems</a> facet
            </p>
            <p>The <a href="#lineitems">lineitems</a> facet contains formulas that calculate
                the <code>Line Cost</code> and <code>Line Offer</code> cells for each row as
                well as the aggregate values <code>total_cost</code>,
                <code>total_offer</code> and <code>profit</code> that are displayed at the
                bottom of the table</p>
        </div>

        <div x-data="simpleNoSheetTable('lineitemsTable')">
            <table>
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>Item Cost</th>
                        <th>Unit Price</th>
                        <th>Quantity</th>
                        <th>Line Cost</th>
                        <th>Line Offer</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="(item, index) in items" :key="index">
                        <tr :id="`${storeId}-row[${index}]`">
                            <template x-for="(column, column_index) in Array(6)">
                                <td>

                                    <template x-if="column_index > 0 && column_index <= 3">
                                        <input type="number" min="0"
                                            :value="item[column_index]"
                                            @input="setCellValue(index, column_index, +$el.value)">
                                    </template>

                                    <template x-if="!column_index">
                                        <!--Don't update on calculation-->
                                        <span x-text="item[column_index]"></span>
                                    </template>

                                    <template x-if="column_index >= 4">
                                        <!--Update on calculation-->
                                        <!-- calculation may occur during load/unload in which case items[index] may be 'undefined' -->
                                        <div x-text="item[column_index]"
                                            x-init="$watch('calculationTick', _ => $el.innerHTML = items[index]?.[column_index])">
                                        </div>
                                    </template>

                                </td>
                            </template>
                        </tr>
                    </template>
                    <tr x-show="isEmpty">
                        <td colspan="5">No matching records found.</td>
                    </tr>
                </tbody>
                <tfoot>
                    <tr>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th>
                            <div x-data="aggregate('total_cost')" x-text="value"></div>
                        </th>
                        <th>
                            <div x-data="aggregate('total_offer')" x-text="value"></div>
                        </th>
                    </tr>
                    <tr>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th>Profit:</th>
                        <th>
                            <div x-data="aggregate('profit')" x-text="value"></div>
                        </th>
                    </tr>

                </tfoot>
            </table>

            <div>
                <button
                    @click="storedTable.load(getRandomData(), 'random_data');reset();">Load
                    Random Data</button>
                <button @click="storedTable.unload('random_data');reset();">Unload All
                    Random Data</button>
            </div>

        </div> <!-- simpleTable()-->

        <div>
            <hr>
            <h3>Create and populate the noSheet table:</h3>
            <pre>
                <code id="prism-1" class="language-javascript"></code>
            </pre>                                        
            <h3 id="lineitems">The line items facet:</h3>
            <pre>
                <code src="/js/examples/facets/lineitems.mjs" class="prism-fetch language-javascript"></code>
            </pre>                                        
        </div>
    </main>        
    <script>
        const SUM = formulajs.SUM;

        //
        // Load the noSheet library, facets and create and populate a table
        //    
        var whenNoSheetReady = new Promise((resolve) => {

            (async () => {

                //the library
                const { defineStack, createTable } = await import('/js/nosheet.min.mjs');

                //the facets
                const { default: lineitems } = await import('/js/examples/facets/lineitems.mjs');

                //the data
                const response = await fetch('/js/examples/data/example_1.json');
                const data = response.ok ? await response.json() : [];

                //-prism
                //
                //create and define the table
                //        
                let new_table = createTable(['item', 'unit_cost', 'unit_offer', 'quantity'], lineitems);

                //
                //populate the table
                //
                new_table.load(data);
                new_table.calculate();
                //-prism

                resolve(new_table);
            })()
        });

        //
        //Plumb in Alpine
        //
        document.addEventListener('alpine:init', () => {

            console.log('alpine:init');
            Alpine.store('lineitemsTable', {});

            whenNoSheetReady.then((theTable) => {

                console.log('whenNoSheetReady');

                //update the store with the loaded nosheet table
                Alpine.store('lineitemsTable', theTable);
            });
        });       
    </script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" crossorigin="anonymous"></script>
</body>
</html>