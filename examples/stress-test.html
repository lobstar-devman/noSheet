<!DOCTYPE html>
<!-- noSheetLibrary --->
<html lang="en" dir="ltr" data-theme="light">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <meta name="color-scheme" content="dark light">

    <title>Stress Test | NoSheet</title>
    <!-- Stylesheets --->
    <link href="css/prism.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.classless.min.css">
    <style>
        :root {
            --pico-font-size: 100%;
        }

        input[type="number"] {
            margin-bottom: 0;
        }

        .parent {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: 1fr;
            grid-column-gap: var(--pico-spacing);
            grid-row-gap: 0px;
        }

        .div1 {
            grid-area: 1 / 1 / 2 / 2;
        }

        .div2 {
            grid-area: 1 / 2 / 2 / 3;
        }

        .div3 {
            grid-area: 1 / 3 / 2 / 4;
        }
    </style>
    <!-- JS Content -->
    <script src="js/examples/utils.js"></script>
    <script src="js/examples/simple_alpine_table.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@formulajs/formulajs/lib/browser/formula.min.js" crossorigin="anonymous"></script>
    <script src="js/prism.js" data-manual></script>

    <script src="https://cors-anywhere.herokuapp.com/https://www.gstatic.com/charts/loader.js" crossorigin="anonymous"></script>
    <script src="https://www.gstatic.com/charts/loader.js" crossorigin="anonymous"></script>
</head>

<body>
    <header>
        <hgroup>
            <h1>
                Stress Tester
            </h1>
        </hgroup>
    </header>
    <main>

        <article x-data="{rows:1000, columns:100, samples:1000}">
            <form>
                <fieldset>
                    <div class="parent">
                        <div class="div1">
                            <label for="columns">Columns:
                                <input id="columns" x-model.number="columns" type="number" min="1">
                            </label>

                        </div>
                        <div class="div2">

                            <label for="rows">Rows:</label>
                            <input id="rows" x-model.number="rows" type="number" min="1">
                            </label>

                        </div>
                        <div class="div3">
                            <label for="samples">Max Samples:
                                <input id="samples" x-model.number="samples" type="number" min="1">
                            </label>
                        </div>
                    </div>
                </fieldset>
            </form>
            <button x-data="{title: 'Start'}" @click="$store.noSheetTable.profile(rows, columns, samples); title='Restart';" x-text="title"></button>
        </article>

        <article>
            <h3>Performance Histogram</h3>
            <div id="chart_div"></div>
        </article>

        <div>
            <hr>
            <h3>Facet:</h3>
            <pre>
                <code id="prism-1" class="language-javascript"></code>
            </pre>
        </div>
    </main>
    <script>
        //
        // Load the noSheet library, facets and create and populate a table
        //    
        var whenNoSheetReady = new Promise((resolve) => {

            (async () => {

                //the library
                const { createTable } = await import('/js/nosheet.min.mjs');

                //-prism
                let stress_table = createTable(
                    ['seed'],
                    function (table, row, refs) {

                        for (let i = 1; i <= refs.columns; i++) {

                            row[i] = () => (row.seed + i) / refs.factor;
                        }
                    }
                );

                stress_table.setReferences(function () {

                    this.factor = 1 / 3;
                });
                //-prism

                resolve(stress_table);
            })()
        });

        //
        //Plumb in Alpine
        //
        document.addEventListener('alpine:init', () => {

            console.log('alpine:init');

            whenNoSheetReady.then((theTable) => {

                console.log('whenNoSheetReady');

                let column_reference = theTable.getReferenceHandle('columns', 10);

                Alpine.store('noSheetTable', {

                    timerId: 0,
                    samples: [],
                    profile(rows, columns, max_samples) {

                        this.samples = [];
                        clearInterval(this.timerId);

                        theTable.unload();
                        theTable.load(Array.from({ length: rows }, _ => [Math.random()]));

                        //this will force a recalc
                        column_reference.value = columns;

                        this.timerId = window.setTimeout(
                            (obj) => obj.calculate(max_samples),
                            200,
                            this
                        );
                    },

                    calculate(max_samples) {

                        //this will force a recalculation
                        let mark = window.performance.now();

                        theTable.calculate();

                        this.samples.push([window.performance.now() - mark]);

                        if (this.samples.length > max_samples) {

                            this.samples.shift();
                        }

                        drawChart();

                        this.timerId = window.setTimeout(
                            (obj) => obj.calculate(max_samples),
                            200,
                            this
                        );
                    }
                });

                //https://developers.google.com/chart/interactive/docs/gallery/histogram
            });

            google.charts.load("current", { packages: ["corechart"] });
            google.charts.setOnLoadCallback(drawChart);

            var options = {
                legend: { position: 'none' },
                colors: ['#4285F4'],

                chartArea: { width: '90%' },
                hAxis: {
                    viewWindowMode: 'pretty',
                    title: 'execution time in ms',
                    format: '#.#',
                    slantedTextAngle: 75,
                    textStyle: {
                        fontSize: 12
                    },
                    titleTextStyle: {
                        italic: false,
                        fontSize: 14
                    }
                },
                vAxis: {
                    title: 'count',
                    titleTextStyle: {
                        italic: false,
                        fontSize: 14
                    }
                },
                bar: { gap: 0 },

                histogram: {
                    bucketSize: 0.01,
                    maxNumBuckets: 100,
                    minValue: 0,
                    maxValue: 1
                }
            };

            function drawChart() {
                /*        
                https://developers-dot-devsite-v2-prod.appspot.com/chart/interactive/docs/gallery/histogram_f074295fabe49e9cdca3f755b6d6058a2370c392cadbdfa48e4920592cd1e2e9.frame
                https://developers.google.com/chart/interactive/docs/gallery/histogram
                */

                var data = new google.visualization.DataTable();

                data.addColumn('number', 'Time(ms)');
                data.addRows(Alpine.store('noSheetTable')?.samples ?? []);

                var chart = new google.visualization.Histogram(document.getElementById('chart_div'));
                chart.draw(data, options);
            }
        });

    </script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" crossorigin="anonymous"></script>
</body>
</html>