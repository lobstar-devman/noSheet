<!DOCTYPE html>
<!-- noSheetLibrary --->
<html lang="en" dir="ltr" data-theme="light">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <meta name="color-scheme" content="dark light">

    <title>Example 3 - Stacks, Consolidation &amp; References | NoSheet</title>
    <!-- Stylesheets --->
    <link href="css/prism.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.classless.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.colors.min.css">
    <style>
        :root {
            --pico-font-size: 100%;
        }

        input[type="number"] {
            margin-bottom: 0;
        }

        .parent {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(2, 1fr);
            grid-column-gap: var(--pico-spacing);
            grid-row-gap: 0px;
        }

        .div1 {
            grid-area: 1 / 1 / 2 / 2;
        }

        .div2 {
            grid-area: 1 / 2 / 2 / 3;
        }

        .div3 {
            grid-area: 2 / 1 / 3 / 2;
        }

        .div4 {
            grid-area: 2 / 2 / 3 / 3;
        }
    </style>
    <!-- JS Content -->
    <script src="js/examples/utils.js"></script>
    <script src="js/examples/simple_alpine_table.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@formulajs/formulajs/lib/browser/formula.min.js"
        crossorigin="anonymous"></script>
    <script src="js/prism.js" data-manual></script>
</head>

<body>
    <header>
        <hgroup>
            <h1>Example 3 - Stacks, Consolidation &amp; References</h1>
        </hgroup>
        <hgroup>
            <h3>Extending the Quote Calculator to handle multiple sites and multiple suppliers</h3>
        </hgroup>
    </header>
    <main>
        <article>
            <form>
                <fieldset>
                    <div class="parent">
                        <div class="div1">
                            <p>Change the manufacturing cost for all line items by adjusting the
                                <code>manufacturing_cost_per_m2</code>
                                parameter in the <a href="#raw_materials">raw_materials</a> facet
                            </p>
                        </div>
                        <div class="div2">
                            <p>Set a minimum Margin Threshold for the quote through the
                                <code>low_margin_threshold</code> parameter in
                                the <a href="#gross_margin">gross_margin</a> facet
                            </p>
                        </div>
                        <div class="div3">
                            <label for="Manufacturing_Cost">Manufacturing Cost:
                                <input id="Manufacturing_Cost" x-data="referenceHandler('manufacturing_cost_per_m2')"
                                    x-model="value" type="number" min="0" max="100" step="0.1" x-bind="input">
                                <label for="Manufacturing_Cost">per m<sup>2</sup></label>
                            </label>
                        </div>
                        <div class="div4">
                            <label for="Margin_Threshold">Margin Threshold:
                                <input id="Margin_Threshold" x-data="referenceHandler('low_margin_threshold')"
                                    x-model="value" type="number" min="0" max="100" x-bind="input">
                            </label>
                        </div>
                    </div>
                </fieldset>
            </form>
        </article>

        <article>
            <div x-data="{tab: 0}"
                x-effect="ifAvailable($store.siteStack, _ => Alpine.store('activeTable', $store.siteStack.getUniqueTable(`site${tab+1}`)))">

                <hgroup>
                    <h3>Site Quotation</h3>
                </hgroup>
                <p>The site quotation table shows the calculations for the selected site.<br>The <a
                        href="#consolidation">consolidated</a> figures for all of the sites are
                    shown at the top right of the table.</p>

                <div>
                    <button :class="!tab ? 'primary' : 'secondary'" :disabled="!tab" @click="tab = 0">
                        Site 1
                    </button>
                    <button :class="1==tab ?  'primary' : 'secondary'" :disabled="1==tab" @click="tab = 1">
                        Site 2
                    </button>
                    <button :class="2==tab ?  'primary' : 'secondary'" :disabled="2==tab" @click="tab = 2">
                        Site 3
                    </button>
                </div>
                <hr>
                <hgroup>
                    <h5>For all sites:</h5>
                </hgroup>
                <table>
                    <thead>
                        <tr>
                            <th>Total Cost</th>
                            <th>Total Offer</th>
                            <th>Profit</th>
                            <th>Gross Margin</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <th x-data="consolidation('total_cost')" x-text="Number(value).toFixed(2)"></th>
                            <th x-data="consolidation('total_offer')" x-text="Number(value).toFixed(2)"></th>
                            <th x-data="consolidation('profit')" x-text="Number(value).toFixed(2)"></th>
                            <th>
                                <div x-data="consolidation('low_margin_warning')"
                                    :class="value ? 'pico-color-red-500' : 'pico-color-green-500'">
                                    <div x-data="consolidation('gross_margin', percent_format)" x-text="value"></div>
                                </div>
                            </th>
                        </tr>
                    </tbody>
                </table>
        </article>

        <div x-data="simpleNoSheetTable('activeTable')">
            <table class="table-fixed" :class="storeId" x-data="{columns:[]}">
                <thead>
                    <tr>
                        <th x-init="columns.push('item')">
                            Item</th>
                        <th x-init="columns.push('steel_m2')">Steel
                            Used m<sup>2</sup></th>
                        <th x-init="columns.push('unit_cost')">Item Cost
                        </th>
                        <th x-init="columns.push('unit_offer')">Unit Price
                        </th>
                        <th x-init="columns.push('quantity')">Quantity
                        </th>
                        <th x-init="columns.push('line_cost')">Line Cost</th>
                        <th x-init="columns.push('line_offer')">Line Offer
                        </th>
                        <th x-init="columns.push('gross_margin')">Gross
                            Margin</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="(item, row_index) in items" :key="row_index">
                        <tr :id="`${storeId}-row[${row_index}]`">
                            <template x-for="(column_name, html_column_index) in columns">
                                <td x-data="{column_index: storedTable.columnIndex(column_name)}"
                                    :class="`col_${column_name}`"
                                    :id="`${storeId}_cell[${row_index}][${column_index}]`">

                                    <template x-if="[2,3].includes(column_index)">
                                        <input type="number" min="0" :value="item[column_index]"
                                            @input="setCellValue(row_index, column_index, +$el.value)">
                                    </template>

                                    <template x-if="!column_index">
                                        <!--Don't update on calculation-->
                                        <span x-text="item[column_index]"></span>
                                    </template>

                                    <template x-if="[1,4,5,6].includes(column_index)">
                                        <!--Update on calculation-->
                                        <!-- calculation may occur during load/unload in which case items[row_index] may be 'undefined' -->
                                        <div x-text="item[column_index].toFixed(2)"
                                            x-init="$watch('calculationTick', _ => $el.innerHTML = items[row_index]?.[column_index].toFixed(2))">
                                        </div>
                                    </template>

                                    <template x-if="column_index == 7">
                                        <!--Update on calculation-->
                                        <!-- calculation may occur during load/unload in which case items[row_index] may be 'undefined' -->
                                        <div x-text="percent_format.format(item[column_index])"
                                            x-init="$watch('calculationTick', _ => $el.innerHTML = percent_format.format(items[row_index]?.[column_index]))">
                                        </div>
                                    </template>

                                </td>
                            </template>
                        </tr>
                    </template>
                    <tr x-show="isEmpty">
                        <td colspan="5">No matching records
                            found.</td>
                    </tr>
                </tbody>
                <tfoot>
                    <tr>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th>
                            <div x-data="aggregate('total_cost')" x-text="Number(value).toFixed(2)">
                            </div>
                        </th>
                        <th>
                            <div x-data="aggregate('total_offer')" x-text="Number(value).toFixed(2)">
                            </div>
                        </th>
                        <th></th>
                    </tr>
                    <tr>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th>Site Profit:</th>
                        <th>
                            <div x-data="aggregate('profit')" x-text="Number(value).toFixed(2)">
                            </div>
                        </th>
                        <th>
                            <span x-data="aggregate('low_margin_warning')"
                                :class="value ? 'pico-color-red-500' : 'pico-color-green-500'">
                                <div x-data="aggregate('gross_margin', percent_format)" x-text="value"></div>
                            </span>
                        </th>
                    </tr>
                </tfoot>
            </table>

        </div> <!-- simpleTable()-->
        <h3>Steel suppliers</h3>
        <article>
            <p>The steel suppliers table calculates the average cost of supply based on the
                purchase and transportation costs from several suppliers using the <a
                    href="#steel_suppliers">steel_suppliers</a> facet.</p>
        </article>
        <div x-data="simpleNoSheetTable('steelSuppliers')">
            <table width="100%" :class="storeId" x-data="{columns:[]}">
                <thead>
                    <tr>
                        <th x-init="columns.push('supplier')">Supplier</th>
                        <th x-init="columns.push('steel_m2')">Steel
                            Cost<br>m<sup>2</sup></th>
                        <th x-init="columns.push('transport_m2')">
                            Transport Cost m<sup>2</sup></th>
                        <th x-init="columns.push('cost_per_m2')">Supplier
                            Cost m<sup>2</sup></th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="(item, row_index) in items" :key="row_index">
                        <tr :id="`${storeId}-row[${row_index}]`">
                            <template x-for="(column_name, html_column_index) in columns">
                                <td x-data="{column_index: storedTable.columnIndex(column_name)}"
                                    :class="`col_${column_name}`"
                                    :id="`${storeId}_cell[${row_index}][${column_index}]`">

                                    <template x-if="!column_index">
                                        <!--Don't update on calculation-->
                                        <span x-text="item[column_index]"></span>
                                    </template>

                                    <template x-if="[1,2].includes(column_index)">
                                        <input type="number" min="0" step="0.1" :value="item[column_index]"
                                            @input="setCellValue(row_index, column_index, +$el.value)">
                                    </template>

                                    <template x-if="3 == column_index">
                                        <div x-text="item[column_index].toFixed(3)"
                                            x-init="$watch('calculationTick', _ => $el.innerHTML = items[row_index]?.[column_index].toFixed(3))">
                                        </div>
                                    </template>
                                </td>
                            </template>
                        </tr>
                    </template>
                    <tr x-show="isEmpty">
                        <td colspan="5">No matching records found.</td>
                    </tr>
                </tbody>
                <tfoot>
                    <tr>
                        <th></th>
                        <th></th>
                        <th>Average:</th>
                        <th>
                            <div x-data="aggregate('average_cost_per_m2')" x-text="Number(value).toFixed(3)"></div>
                        </th>
                    </tr>
                </tfoot>
            </table>

        </div> <!-- simpleTable()-->

        <div>
            <div>
                <hr>
                <h3>Create and populate the noSheet table:</h3>
                <pre>
                <code id="prism-1" class="language-javascript"></code>
            </pre>
                <h3 id="raw_materials">The raw materials facet:</h3>
                <pre>
                <code src="/js/examples/facets/raw_materials.mjs" class="prism-fetch language-javascript"></code>
            </pre>
                <h3 id="lineitems">The line items facet:</h3>
                <pre>
                <code src="/js/examples/facets/lineitems.mjs" class="prism-fetch language-javascript"></code>
            </pre>
                <h3 id="gross_margin">The gross margin facet:</h3>
                <pre>
                <code src="/js/examples/facets/gross_margin.mjs" class="prism-fetch language-javascript"></code>
            </pre>
                </pre>
                <h3 id="consolidation">The consolidation facet:</h3>
                <pre>
                <code src="/js/examples/facets/consolidation.mjs" class="prism-fetch language-javascript"></code>
            </pre>
                </pre>
                <h3 id="steel_suppliers">The steel suppliers facet:</h3>
                <pre>
                <code src="/js/examples/facets/steel_suppliers.mjs" class="prism-fetch language-javascript"></code>
            </pre>

            </div>
    </main>

    <script>
        const SUM = formulajs.SUM,
            AVERAGE = formulajs.AVERAGE;

        var percent_format = new Intl.NumberFormat(undefined, { style: "percent" });

        //
        // Load the noSheet library, facets and create and populate a table
        //    
        var whenNoSheetReady = new Promise((resolve) => {

            (async () => {

                //the library
                const { defineStack, createTable } = await import('/js/nosheet.min.mjs');

                //the facets
                const { default: raw_materials } = await import('/js/examples/facets/raw_materials.mjs');
                const { default: lineitems } = await import('/js/examples/facets/lineitems.mjs');
                const { default: gross_margin } = await import('/js/examples/facets/gross_margin.mjs');
                const { default: steel_suppliers } = await import('/js/examples/facets/steel_suppliers.mjs');
                const { default: consolidation } = await import('/js/examples/facets/consolidation.mjs');

                //-prism
                //load the data
                const data1 = await loadJSON('/js/examples/data/example_1.json'),
                    data2 = await loadJSON('/js/examples/data/example_3_site_2.json'),
                    data3 = await loadJSON('/js/examples/data/example_3_site_3.json'),
                    data4 = await loadJSON('/js/examples/data/example_3_steel_suppliers.json');

                //
                //create and define the stack, which acts as a table factory and allows us to use consolidation facets
                //        
                let stack = defineStack('item', 'steel_m2', 'unit_offer', 'quantity'),
                    site_1 = stack.createTable('site1'),
                    site_2 = stack.createTable('site2'),
                    site_3 = stack.createTable('site3');

                //set the facets used by the stack
                stack.addFacets(raw_materials, lineitems, gross_margin);

                //set a consolidation facet
                stack.consolidate(consolidation);

                //
                //populate the tables
                //
                site_1.load(data1);
                site_2.load(data2);
                site_3.load(data3);

                //Create a table for the steel suppliers
                let suppliers = createTable(['supplier', 'steel_m2', 'transport_m2'], steel_suppliers);

                //load and calculate
                suppliers.load(data4);
                suppliers.calculate();

                //Set the average_steel_cost_m2 reference required by the raw_materials facets to use
                //the average_cost_per_m2 aggregate from the suppliers table
                stack.setDefaultReferences(function (uses) {

                    this.average_steel_cost_m2 = uses(suppliers).average_cost_per_m2;
                });
                //-prism

                resolve([stack, site_1, site_2, site_3, suppliers]);
            })()
        });

        function referenceHandler(referenceName) {
            return {

                init() {

                    //watch the store for reference initialization
                    this.$watch(`$store.${referenceName}`, (newHandler, oldHandler) => {
                        this.value = newHandler.value;
                    })
                },
                value: '',
                input: {
                    ['@input'](event) {
                        Alpine.store(referenceName).value = +event.srcElement.value;
                    },
                },
            };
        };

        let unavailable = Symbol('unavailable');

        function ifAvailable(obj, fn) {

            let isAvailable = obj !== unavailable;

            return fn && isAvailable ? fn(obj) : isAvailable;
        }

        //
        //Plumb in Alpine
        //
        document.addEventListener('alpine:init', () => {

            console.log('alpine:init');

            Alpine.data('consolidation', (name, formatter) => ({

                init() {
                    //watch the store
                    this.$watch(`$store.consolidated`, (new_value, old_value) => {

                        this.calculatedValue = Alpine.store('siteStack')[name].valueOf();
                    });
                },

                calculatedValue: undefined,

                get value() {

                    let v = this.calculatedValue ?? Alpine.store('siteStack')[name]?.valueOf();

                    return !formatter ? v : formatter.format(v);
                },
            }));

            Alpine.store('steelSuppliers', unavailable);
            Alpine.store('activeTable', unavailable);
            Alpine.store('siteStack', unavailable);
            Alpine.store('consolidated', 0);

            whenNoSheetReady.then(([theStack, site1, site2, site3, suppliers]) => {

                console.log('whenNoSheetReady');

                //Define some reference handles
                Alpine.store('low_margin_threshold', theStack.tables().getReferenceHandle('low_margin_threshold', 30));
                Alpine.store('manufacturing_cost_per_m2', theStack.tables().getReferenceHandle('manufacturing_cost_per_m2', 0.3));

                //set the consolidation refernces to mirror the table consolidation handle
                theStack.setConsolidationReferences(function (uses) {

                    this.low_margin_threshold = Alpine.store('low_margin_threshold').value;
                });

                //increment the consolidation tick to force UI update
                theStack.afterConsolidation(_ => {
                    Alpine.store('consolidated', Alpine.store('consolidated') + 1);
                });

                theStack.tables().calculate();

                //update the store with the init'd objects
                Alpine.store('siteStack', theStack);
                Alpine.store('activeTable', site1);
                Alpine.store('steelSuppliers', suppliers);
            });
        });       
    </script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" crossorigin="anonymous"></script>
</body>

</html>